# =====================================
# API Server Dockerfile
# Multi-stage build for minimal image
# =====================================

# Stage 1: Build
FROM node:20-alpine AS builder

WORKDIR /app

# Install dependencies first (cache layer)
COPY package*.json ./
COPY packages/api/package*.json ./packages/api/

RUN npm ci --workspace=@crawlee-cloud/api --ignore-scripts

# Copy source and build
COPY tsconfig.base.json ./
COPY packages/api ./packages/api

RUN npm run build --workspace=@crawlee-cloud/api

# Stage 2: Production
FROM node:20-alpine AS production

WORKDIR /app

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
  adduser -S nodejs -u 1001

# Copy built files
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/packages/api/package*.json ./packages/api/
COPY --from=builder /app/packages/api/dist ./packages/api/dist

# Install production dependencies only
RUN npm ci --omit=dev --workspace=@crawlee-cloud/api --ignore-scripts

USER nodejs

EXPOSE 3000

ENV NODE_ENV=production

CMD ["node", "packages/api/dist/index.js"]
